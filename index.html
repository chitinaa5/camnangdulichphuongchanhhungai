<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DuLichChanhHungAI</title>
<style>
	/* ===== KHUNG GIá»šI THIá»†U ===== */
#infoPanel{
  position:fixed;
  top:-100%;
  left:0;
  width:100%;
  height:100%;
  background:#fffaf0;
  border-bottom:4px solid #e2c97d;
  z-index:99;
  overflow-y:auto;
  transition:top 0.6s ease;
  box-sizing:border-box;
  padding:20px;
}
#infoPanel.open{ top:60px; }
#infoPanel h2{ text-align:center; color:#b3883b; margin:0 0 10px; }
.info-header{ position:relative; }
#closeInfoBtn{
  position:absolute; top:0; right:0;
  background:#d9b877; border:none; color:#fff;
  padding:6px 10px; border-radius:6px; cursor:pointer;
  font-weight:600;
}
#tabButtons{ display:flex; justify-content:center; gap:8px; margin-top:10px; }
.tabBtn{
  background:#e0c177; border:none; border-radius:6px;
  padding:8px 14px; cursor:pointer; color:white; font-weight:600;
}
.tabBtn.active{ background:#b3883b; }
.tabContent{ display:none; margin-top:12px; color:#3d2b1f; line-height:1.6; }
.tabContent.active{ display:block; }

  :root{
    --accent:#0b66ff;
    --panel-bg:#fff7e0;
    --panel-text:#3b3024;
    --warm:#d9b57b;
    --warm-dark:#c48f3a;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f6f3ec;color:#222}
  header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:white;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
  header h1{margin:0;font-size:18px;color:var(--accent)}
  header .subtitle{font-size:12px;color:#666}
  main{display:flex;gap:12px;padding:12px;box-sizing:border-box;height:calc(100vh - 62px)}
  /* map area */
  #mapWrap{flex:1;border-radius:10px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#eaf6fb}
  #mapBase{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:0.98}
  #mapCanvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:5}
  #markerLabel{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:8px;display:none;z-index:30;font-size:14px;color:#111;text-align:center;white-space:pre-line}
  .save-row{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);z-index:30;display:flex;gap:8px}
  .save-btn{background:linear-gradient(180deg,var(--warm),var(--warm-dark));border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600;display:flex;gap:8px;align-items:center;box-shadow:0 6px 14px rgba(0,0,0,0.12);cursor:pointer}
  /* chat panel */
  .panel{width:360px;display:flex;flex-direction:column;gap:8px;background:var(--panel-bg);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);position:relative;color:var(--panel-text)}
  .panel h2{margin:0;font-size:16px}
  .chat{background:transparent;padding:8px;border-radius:8px;flex:1;overflow:auto;border:1px dashed rgba(0,0,0,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd}
  button.small{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.alt{background:#28a745}
  footer{padding:8px 12px;font-size:13px;color:#666;background:transparent;border-top:0;margin-top:6px}
  .msg.user{color:var(--accent);margin-bottom:6px}
  .msg.bot{color:#222;margin-bottom:6px}
  .compass{position:absolute;top:12px;right:12px;width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;z-index:40}
  .compass svg{width:36px;height:36px;transform-origin:center;animation:spin 8s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  @media(max-width:900px){main{flex-direction:column} .panel{width:100%;height:360px} #mapWrap{height:360px}}
  <!-- Khung chi tiáº¿t Ä‘á»‹a Ä‘iá»ƒm -->
<div id="detailPanel" style="
  display:none;
  background:#fff8e1;
  border-radius:12px;
  padding:15px;
  margin-top:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
">
  <h3 id="detailTitle" style="margin:0;color:#444;font-weight:bold;"></h3>
  <p id="detailAddress" style="margin:5px 0;color:#555;"></p>
  <p id="detailHours" style="margin:5px 0;color:#777;"></p>
  <div id="detailDesc" style="margin-top:10px;color:#333;"></div>
</div>
</style>
</head>
<body>
	<!-- Popup chi tiáº¿t Ä‘á»‹a Ä‘iá»ƒm -->
<div id="detailPanel" style="
  display:none; position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%); background:white; border-radius:12px;
  padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3);
  width:90%; max-width:420px; z-index:999; color:#333;">
  <h3 id="detailTitle" style="margin-top:0;color:#b3883b"></h3>
  <p id="detailAddress" style="margin:6px 0;font-size:14px;color:#444"></p>
  <p id="detailHours" style="margin:6px 0;font-size:13px;color:#555"></p>
  <p id="detailDesc" style="margin:10px 0;line-height:1.6;"></p>
  <button id="closeDetailBtn" style="
    background:#b3883b;color:#fff;border:none;padding:8px 12px;
    border-radius:8px;cursor:pointer;font-weight:600;">ÄÃ³ng</button>
</div>
<header>
  <div style="width:44px;height:44px;flex:0 0 44px">
    <svg viewBox="0 0 64 64" width="44" height="44" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#4facfe"/><stop offset="1" stop-color="#00f2fe"/></linearGradient></defs>
      <path d="M8 8 L28 4 L44 12 L24 18 Z" fill="url(#g)"/>
      <path d="M8 28 L28 24 L44 32 L24 38 Z" fill="#a7f3d0"/>
    </svg>
  </div>
  <div style="display:flex;flex-direction:column">
    <h1>DuLichChanhHungAI</h1>
    <div class="subtitle">HÆ°á»›ng dáº«n viÃªn du lá»‹ch AI â€” PhÆ°á»ng ChÃ¡nh HÆ°ng</div>
  </div>
</header>
<!-- ===== KHUNG GIá»šI THIá»†U / Lá»ŠCH Sá»¬ ===== -->
<div id="infoPanel">
  <div class="info-header">
    <h2>ğŸ“˜ Giá»›i thiá»‡u PhÆ°á»ng ChÃ¡nh HÆ°ng</h2>
    <button id="closeInfoBtn">ÄÃ³ng</button>
  </div>

  <div id="tabButtons">
    <button class="tabBtn active" data-tab="history">ğŸ•°ï¸ Lá»‹ch sá»­</button>
    <button class="tabBtn" data-tab="food">ğŸœ áº¨m thá»±c</button>
    <button class="tabBtn" data-tab="culture">ğŸ¯ VÄƒn hÃ³a</button>
    <button class="tabBtn" data-tab="tour">ğŸ—ºï¸ Tour</button>
  </div>

  <div id="history" class="tabContent active">
    <p><b>PhÆ°á»ng ChÃ¡nh HÆ°ng</b> náº±m á»Ÿ trung tÃ¢m Quáº­n 8(cÅ©), TP. Há»“ ChÃ­ Minh, ná»•i báº­t vá»›i há»‡ thá»‘ng kÃªnh ráº¡ch vÃ  cÃ¡c khu dÃ¢n cÆ° lÃ¢u Ä‘á»i.
    TrÆ°á»›c Ä‘Ã¢y lÃ  lÃ ng HÆ°ng PhÃº, nÆ¡i gáº¯n liá»n vá»›i quÃ¡ trÃ¬nh hÃ¬nh thÃ nh vÃ¹ng Nam Bá»™, tráº£i qua nhiá»u giai Ä‘oáº¡n phÃ¡t triá»ƒn Ä‘Ã´ thá»‹ vÃ  vÄƒn hÃ³a phong phÃº.</p>
  </div>

  <div id="food" class="tabContent">
    <p>Khu vá»±c Táº¡ Quang Bá»­u lÃ  thiÃªn Ä‘Æ°á»ng áº©m thá»±c, tá»« <b>mÃ¬ cay Sasin</b> Ä‘áº¿n <b>lÃ ng nÆ°á»›ng Nam Bá»™</b>.  
    NgoÃ i ra cÃ²n cÃ³ <b>Highlands Coffee</b> vÃ  <b>Katinat</b> phá»¥c vá»¥ cÃ  phÃª hiá»‡n Ä‘áº¡i cho du khÃ¡ch.</p>
  </div>

  <div id="culture" class="tabContent">
    <p>PhÆ°á»ng cÃ³ nhiá»u Ä‘iá»ƒm tÃ´n giÃ¡o nhÆ° <b>NhÃ  thá» Nam Háº£i</b>, <b>ÄÃ¬nh HÆ°ng PhÃº</b> vÃ  <b>ChÃ¹a An PhÃº</b>, táº¡o nÃªn khÃ´ng gian tÃ­n ngÆ°á»¡ng Ä‘áº·c trÆ°ng Nam Bá»™.</p>
  </div>

  <div id="tour" class="tabContent">
    <p>âœ¨ <b>Tour gá»£i Ã½:</b></p>
    <ol>
      <li>NhÃ  thá» Nam Háº£i â€“ má»Ÿ Ä‘áº§u hÃ nh trÃ¬nh tÃ¢m linh.</li>
      <li>ÄÃ¬nh HÆ°ng PhÃº â€“ khÃ¡m phÃ¡ kiáº¿n trÃºc cá»•.</li>
      <li>Central Premium Mall â€“ trung tÃ¢m thÆ°Æ¡ng máº¡i hiá»‡n Ä‘áº¡i.</li>
      <li>LÃ ng NÆ°á»›ng Nam Bá»™ â€“ thÆ°á»Ÿng thá»©c áº©m thá»±c Ä‘á»‹a phÆ°Æ¡ng.</li>
      <li>Cáº§u Chá»¯ Y â€“ biá»ƒu tÆ°á»£ng ná»‘i káº¿t Quáº­n 5 vÃ  Quáº­n 8.</li>
    </ol>
  </div>
</div>
<main>
  <div id="mapWrap" aria-label="Báº£n Ä‘á»“ 2D phong cÃ¡ch pastel">
    <!-- Báº¡n pháº£i Ä‘áº·t map_base.png (2560x1600) vÃ o cÃ¹ng thÆ° má»¥c -->
    <img id="mapBase" src="map_base.png" alt="Báº£n Ä‘á»“ ná»n" />
    <canvas id="mapCanvas"></canvas>
    <div id="markerLabel"></div>

    <div class="save-row">
      <button id="saveBtn" class="save-btn" title="LÆ°u lá»™ trÃ¬nh (GPX)">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path fill="#fff" d="M12 2C9.8 2 8 3.8 8 6c0 3.6 4 7.7 4 7.7S16 9.6 16 6c0-2.2-1.8-4-4-4zm0 16.5c-1.7 0-3-1.3-3-3H9c0 1.1.9 2 2 2s2-.9 2-2h0c0 1.7-1.3 3-3 3z"/>
        </svg>
        LÆ°u lá»™ trÃ¬nh
      </button>
    </div>
  </div>

  <div class="panel" role="region" aria-label="Chatbot">
    <h2>ChÃ¡nh HÆ°ng AI</h2>

    <div class="compass" title="La bÃ n">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="bronze" x1="0" x2="1"><stop offset="0" stop-color="#d99f4a"/><stop offset="1" stop-color="#b0762b"/></linearGradient></defs>
        <circle cx="32" cy="32" r="28" fill="url(#bronze)" stroke="#8a5e2a" stroke-width="1.5"/>
        <polygon points="32,12 38,32 32,28 26,32" fill="#fff3db" opacity="0.9"/>
        <circle cx="32" cy="32" r="4" fill="#fff3db"/>
      </svg>
    </div>

    <div id="chatBox" class="chat" aria-live="polite"></div>

    <div style="display:flex;gap:8px;align-items:center">
      <input id="userInput" type="text" placeholder="GÃµ: 'Cho tÃ´i tour áº©m thá»±c'..." aria-label="Nháº­p yÃªu cáº§u"/>
      <button id="sendBtn" class="small">Gá»­i</button>
    </div>

    <div class="controls">
      <button id="routeModeBtn" class="small alt">ğŸ—ºï¸ Chá»n lá»™ trÃ¬nh</button>
      <button id="narrateBtn" class="small">ğŸ™ï¸ Thuyáº¿t minh</button>
      <button id="listenBtn" class="small">ğŸ§ Nghe</button>
      <button id="exportBtn" class="small">ğŸ’¾ Xuáº¥t data.json</button>
      <button id="uploadBtn" class="small alt">ğŸ“‚ Upload data.json</button>
      <input id="fileInput" type="file" accept=".json" style="display:none" />
    </div>

    <div style="margin-top:8px;font-size:13px;color:#444">
      <b>Lá»i chÃ o:</b> Xin chÃ o! MÃ¬nh lÃ  <b>ChÃ¡nh HÆ°ng AI</b> â€” hÆ°á»›ng dáº«n viÃªn du lá»‹ch cá»§a báº¡n ğŸŒ
    </div>

    
  </div>
</main>

<script>
/* ---------------------------
  Helper UI / speech functions
   --------------------------- */
const chatBox = document.getElementById('chatBox');
function appendUser(t){ const d=document.createElement('div'); d.className='msg user'; d.textContent='Báº¡n: '+t; chatBox.appendChild(d); chatBox.scrollTop=chatBox.scrollHeight; }
function appendBot(t){ const d=document.createElement('div'); d.className='msg bot'; d.textContent='ChÃ¡nh HÆ°ng AI: '+t; chatBox.appendChild(d); chatBox.scrollTop=chatBox.scrollHeight; }

function pickFemaleVoice(){
  const voices = window.speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  let v = voices.find(voice => voice.lang && voice.lang.startsWith('vi') && /female|ná»¯|thu/i.test(voice.name));
  if(!v) v = voices.find(voice => voice.lang && voice.lang.startsWith('vi'));
  if(!v) v = voices[0];
  return v;
}
function speak(text){
  return new Promise(res=>{
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'vi-VN';
      const v = pickFemaleVoice();
      if(v) u.voice = v;
      u.rate = 1.0;
      u.onend = res;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){
      console.warn(e);
      setTimeout(res,700);
    }
  });
}

/* --- load locations (data.json) --- */
window.locations = window.locations || null;
async function loadLocations(){
  if(window.locations && window.locations.length) return window.locations;
  try{
    const r = await fetch('data.json');
    window.locations = await r.json();
    return window.locations;
  }catch(e){
    window.locations = [];
    return window.locations;
  }
}

/* ---------------------------
   Map canvas (2D flat map)
   --------------------------- */
(function(){
  const wrap = document.getElementById('mapWrap');
  const canvas = document.getElementById('mapCanvas');
  const ctx = canvas.getContext('2d');
  const mapImg = document.getElementById('mapBase');
  const label = document.getElementById('markerLabel');
  const saveBtn = document.getElementById('saveBtn');

  let DPR = window.devicePixelRatio || 1;
  let zoom = 1, panX = 0, panY = 0;
  let dragging = false, last = {x:0,y:0};
  window.routePoints = window.routePoints || [];
  window.routeMode = false;

  function resize(){
    const w = wrap.clientWidth, h = wrap.clientHeight;
    DPR = window.devicePixelRatio || 1;
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    draw();
  }
  window.addEventListener('resize', resize);

  // bbox mapping from lat/lng to image pixels
  // we will set imageBounds below after loading data / map (center at NhÃ  Thá» Nam Háº£i)
  let bbox = null;
  // default bbox (will be overwritten by computeBBox)
  function computeBBox(){
  	
    if(!window.locations || window.locations.length===0) return null;
    let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
    window.locations.forEach(p=>{
      const lat = parseFloat(p.lat), lng = parseFloat(p.lng);
      if(isFinite(lat) && isFinite(lng)){
        minLat = Math.min(minLat, lat);
        maxLat = Math.max(maxLat, lat);
        minLng = Math.min(minLng, lng);
        maxLng = Math.max(maxLng, lng);
      }
    });
    if(!isFinite(minLat)) return null;
    // expand a bit to include margins on image
    const padLat = (maxLat-minLat)*0.6 || 0.003;
    const padLng = (maxLng-minLng)*0.6 || 0.003;
    bbox = {
    minLat: 10.7271835, // gÃ³c dÆ°á»›i (Nam)
    maxLat: 10.7519689, // gÃ³c trÃªn (Báº¯c)
    minLng: 106.6630032, // bÃªn trÃ¡i (TÃ¢y)
    maxLng: 106.6929469  // bÃªn pháº£i (ÄÃ´ng)
  };
  return bbox;
}


  // map lat/lng to pixel coordinates relative to image displayed
  function latLngToImgXY(lat,lng){
    if(!bbox) return {x:0,y:0};
    // image natural size relative mapping: u for x, v for y
    const u = (lng - bbox.minLng) / (bbox.maxLng - bbox.minLng);
    const v = 1 - ((lat - bbox.minLat) / (bbox.maxLat - bbox.minLat));
    const w = wrap.clientWidth, h = wrap.clientHeight;
    return { x: u * w, y: v * h };
  }

  // --- Cache icon pastel ---
const iconCache = {};
const basePath = "./"; // vÃ¬ táº¥t cáº£ hÃ¬nh náº±m cÃ¹ng thÆ° má»¥c index.html
const iconPaths = {
  "áº©m thá»±c": basePath + "food.png",
  "vÄƒn hÃ³a": basePath + "culture.png",
  "trung tÃ¢m thÆ°Æ¡ng máº¡i": basePath + "mall.png",
  "y táº¿": basePath + "health.png",
  "vui chÆ¡i": basePath + "fun.png",
  "cáº§u chá»¯ y": basePath + "bridge.png",
  "gá»£i Ã½": basePath + "bridge.png",
  "default": basePath + "bridge.png"
};

// Náº¡p trÆ°á»›c hÃ¬nh icon
for (const key in iconPaths) {
  const img = new Image();
  img.src = iconPaths[key];
  iconCache[key] = img;
}

// --- HÃ m váº½ chÃ­nh ---
// --- HÃ m váº½ chÃ­nh ---
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Váº½ Ä‘Æ°á»ng Ä‘i (route)
  if (window.routePoints && window.routePoints.length >= 2) {
    ctx.beginPath();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#007bff";
    window.routePoints.forEach((p, i) => {
      const pt = latLngToImgXY(parseFloat(p.lat), parseFloat(p.lng));
      if (i === 0) ctx.moveTo(pt.x, pt.y);
      else ctx.lineTo(pt.x, pt.y);
    });
    ctx.stroke();
  }

  // Váº½ icon marker cÃ¢n báº±ng vá»‹ trÃ­ & kÃ­ch thÆ°á»›c
  (window.locations || []).forEach(loc => {
    const p = latLngToImgXY(parseFloat(loc.lat), parseFloat(loc.lng));
    let key = "default";
    if (loc.category && iconCache[loc.category]) key = loc.category;

    const img = iconCache[key];
    if (img && img.complete) {
      const baseSize = 40; // icon lá»›n hÆ¡n chÃºt
const size = baseSize;
const offsetY = size * 0.3; // cÃ¢n tÃ¢m icon giá»‘ng "vui chÆ¡i"
ctx.drawImage(img, p.x - size / 2, p.y - size / 2, size, size);
    } else {
      // fallback khi icon chÆ°a load
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fillStyle = "#e85a4f";
      ctx.fill();
    }
  });
}
  // simple drag to pan (moves underlying image via CSS transform)
  let imgPanX = 0, imgPanY = 0;
  // KhÃ´ng cho zoom hoáº·c di chuyá»ƒn ná»n báº£n Ä‘á»“
function applyImageTransform(){
  mapImg.style.transform = 'none';
}

  canvas.addEventListener('pointerdown', e=>{
    dragging = true; last={x:e.clientX,y:e.clientY}; canvas.setPointerCapture(e.pointerId);
  });
  canvas.addEventListener('pointerup', e=>{ dragging=false; try{ canvas.releasePointerCapture(e.pointerId);}catch(_){} });
  canvas.addEventListener('pointermove', e=>{
    if(dragging){
      const dx = e.clientX - last.x; const dy = e.clientY - last.y;
      imgPanX += dx; imgPanY += dy;
      last = {x:e.clientX,y:e.clientY};
      applyImageTransform(); draw();
    }
  });

  // wheel zoom (desktop)
  // Táº¯t tÃ­nh nÄƒng zoom ná»n
canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  // KhÃ´ng thay Ä‘á»•i zoom
  appendBot('ğŸ”’ Chá»©c nÄƒng zoom báº£n Ä‘á»“ Ä‘Ã£ bá»‹ táº¯t Ä‘á»ƒ trÃ¡nh lá»‡ch ná»n.');
});

  // click detection: show address + speak (no auto pan/zoom)
  canvas.addEventListener('click', async e=>{
    const rect = canvas.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    let found = null, minDist = 20;
    (window.locations || []).forEach(loc=>{
      const p = latLngToImgXY(parseFloat(loc.lat), parseFloat(loc.lng));
      const d = Math.hypot(p.x - cx, p.y - cy);
      if(d < minDist){ found = loc; minDist = d; }
    });
    if(!found) return;
    label.style.display = 'block'; label.innerText = `${found.name}\nÄá»‹a chá»‰: ${found.address}`;
    setTimeout(()=> label.style.display='none', 3500);
    appendBot(`ğŸ“ ${found.name}\nÄá»‹a chá»‰: ${found.address}`);
    await speak(`Äá»‹a chá»‰ cá»§a ${found.name} lÃ  ${found.address}`);
// --- Hiá»ƒn thá»‹ popup chi tiáº¿t khi nháº¥n icon trÃªn báº£n Ä‘á»“ ---
document.getElementById('detailTitle').textContent = found.name;
document.getElementById('detailAddress').textContent = 'ğŸ“ ' + found.address;
document.getElementById('detailHours').textContent = 'ğŸ•“ Giá» má»Ÿ cá»­a: ' + (found.open_hours || 'KhÃ´ng rÃµ');

document.getElementById('detailDesc').innerHTML = `
  ${found.desc || 'ChÆ°a cÃ³ mÃ´ táº£.'}
  <div style="margin-top:12px;text-align:center;">
    <button id="showDetailBtn"
      style="background:#b3883b;color:#fff;border:none;
      padding:10px 14px;border-radius:8px;
      cursor:pointer;font-weight:600;">
      ğŸ“– Giá»›i thiá»‡u chi tiáº¿t
    </button>
  </div>`;

document.getElementById('detailPanel').style.display = 'block';

document.getElementById('showDetailBtn').onclick = () => {
  alert("ğŸ“˜ ThÃ´ng tin chi tiáº¿t:\n" + (found.desc || 'ChÆ°a cÃ³ mÃ´ táº£.'));
};
    if(window.routeMode){
      window.routePoints = window.routePoints || [];
      window.routePoints.push({lat: found.lat, lng: found.lng});
      draw();
    }
  });

  // save GPX
  saveBtn.addEventListener('click', ()=>{
    const pts = window.routePoints || [];
    if(!pts || pts.length===0){ appendBot('ğŸŒ¸ Báº¡n chÆ°a chá»n Ä‘iá»ƒm nÃ o Ä‘á»ƒ lÆ°u lá»™ trÃ¬nh nha.'); return; }
    const enriched = pts.map(p=>{
      const found = (window.locations||[]).find(l=> String(l.lat)==String(p.lat) && String(l.lng)==String(p.lng));
      return { lat: p.lat, lng: p.lng, name: found?found.name:'' };
    });
    const now = new Date().toISOString();
    let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="DuLichChanhHungAI" xmlns="http://www.topografix.com/GPX/1/1">\n  <metadata>\n    <name>lo_trinh_camhung</name>\n    <time>${now}</time>\n  </metadata>\n  <trk>\n    <name>lo_trinh_camhung</name>\n    <trkseg>\n`;
    enriched.forEach(p => {
      const name = (p.name||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      gpx += `      <trkpt lat="${p.lat}" lon="${p.lng}"><name>${name}</name></trkpt>\n`;
    });
    gpx += '    </trkseg>\n  </trk>\n</gpx>';
    const blob = new Blob([gpx], {type:'application/gpx+xml'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lo_trinh_camhung.gpx'; a.click(); URL.revokeObjectURL(a.href);
    appendBot('ğŸ’¾ ÄÃ£ táº¡o file GPX: lo_trinh_camhung.gpx');
  });
// --- Hiá»ƒn thá»‹ chi tiáº¿t Ä‘á»‹a Ä‘iá»ƒm ---
document.addEventListener('click', e => {
  if (e.target.classList.contains('detail-btn')) {
    const name = e.target.dataset.name;
    const loc = (window.locations || []).find(l => l.name === name);
    if (!loc) return;
    document.getElementById('detailTitle').textContent = loc.name;
    document.getElementById('detailAddress').textContent = 'ğŸ“ ' + loc.address;
    document.getElementById('detailHours').textContent = 'ğŸ•“ Giá» má»Ÿ cá»­a: ' + (loc.open_hours || 'KhÃ´ng rÃµ');
    document.getElementById('detailDesc').textContent = loc.desc || 'ChÆ°a cÃ³ mÃ´ táº£.';
    document.getElementById('detailPanel').style.display = 'block';
  }
});

document.getElementById('closeDetailBtn').addEventListener('click', ()=>{
  document.getElementById('detailPanel').style.display = 'none';
});
  // init
  loadLocations().then(()=>{
    computeBBox();
    resize();
    draw();
  });
})();
  
/* --- UI: route mode, narrate, listen, export/upload --- */
const routeModeBtn = document.getElementById('routeModeBtn');
routeModeBtn.addEventListener('click', ()=>{
  window.routeMode = !window.routeMode;
  routeModeBtn.textContent = window.routeMode ? 'Äang chá»n lá»™ trÃ¬nh (báº¥m Ä‘á»ƒ táº¯t)' : 'ğŸ—ºï¸ Chá»n lá»™ trÃ¬nh';
});

const narrateBtn = document.getElementById('narrateBtn');
narrateBtn.addEventListener('click', async ()=>{
  if(!window.routePoints || window.routePoints.length === 0){ appendBot('ChÆ°a cÃ³ tuyáº¿n Ä‘á»ƒ thuyáº¿t minh.'); return; }
  appendBot('ğŸ§ Báº¯t Ä‘áº§u thuyáº¿t minh...');
  for(let i=0;i<window.routePoints.length;i++){
    const p = window.routePoints[i];
    const loc = (window.locations||[]).find(l=> String(l.lat)==String(p.lat) && String(l.lng)==String(p.lng)) || {name:'Äiá»ƒm '+(i+1), address:''};
    appendBot((i+1)+'. '+loc.name+': '+(loc.address||''));
    await speak(`Äiá»ƒm ${i+1}: ${loc.name}. Äá»‹a chá»‰: ${loc.address || 'khÃ´ng rÃµ'}`);
  }
  appendBot('ğŸ‰ HoÃ n thÃ nh!');
});

const listenBtn = document.getElementById('listenBtn');
listenBtn.addEventListener('click', ()=>{
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ appendBot('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n giá»ng.'); return; }
  const rec = new SR(); rec.lang='vi-VN';
  rec.onresult = (e)=>{
    const t = e.results[0][0].transcript;
    appendUser(t);
    if(/tour|tuyáº¿n|gá»£i Ã½|áº©m thá»±c|Äƒn/i.test(t)) createAutoRoute(t);
    else{
      const found = (window.locations||[]).find(l=> t.toLowerCase().includes(l.name.toLowerCase()));
      if(found){ appendBot(found.address); speak(found.address); } else appendBot('MÃ¬nh chÆ°a hiá»ƒu. Thá»­ nÃ³i "Cho tÃ´i tour áº©m thá»±c".');
    }
  };
  rec.onerror = ()=> appendBot('Lá»—i nháº­n dáº¡ng giá»ng nÃ³i');
  rec.start(); appendBot('ğŸ§ Äang nghe...');
});

function createAutoRoute(text){
  let candidates = (window.locations||[]).slice();
  if(/áº©m thá»±c|Äƒn|quÃ¡n|cÃ  phÃª|nhÃ  hÃ ng|mÃ¬|nÆ°á»›ng/i.test(text)) candidates = (window.locations||[]).filter(l=> /cÃ  phÃª|mÃ¬|nÆ°á»›ng|Highlands|LÃ€NG|lÃ ng/i.test(l.name) || /cÃ  phÃª|áº©m thá»±c|mÃ¬|nÆ°á»›ng/i.test(l.desc));
  const chosen = candidates.slice(0, Math.min(6, candidates.length));
  window.routePoints = chosen.map(c=> ({lat:c.lat,lng:c.lng}));
  appendBot('âœ¨ ÄÃ£ táº¡o tuyáº¿n gá»£i Ã½ ('+chosen.length+' Ä‘iá»ƒm).');
  // redraw
  if(window.map3d && window.map3d.draw) window.map3d.draw();
}

/* export / upload data.json */
const exportBtn = document.getElementById('exportBtn');
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(window.locations||[],null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.json'; a.click(); URL.revokeObjectURL(a.href);
  appendBot('ÄÃ£ xuáº¥t data.json');
});
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
uploadBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const j = JSON.parse(txt);
    window.locations = j;
    // recompute bbox
    if(window.map3d && window.map3d.resize) window.map3d.resize();
    appendBot('ÄÃ£ náº¡p data.json');
  }catch(err){ appendBot('File khÃ´ng há»£p lá»‡'); }
});

/* send */
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
sendBtn.addEventListener('click', ()=>{
  const t = userInput.value.trim();
  if(!t) return;
  appendUser(t);
  userInput.value = '';

  // --- TOUR VÄ‚N HÃ“A ---
  if (/tour vÄƒn hÃ³a|vÄƒn hÃ³a|Ä‘Ã¬nh|chÃ¹a|nhÃ  thá»/i.test(t)) {
    appendBot("ğŸ¯ Äá» xuáº¥t tour vÄƒn hÃ³a táº¡i PhÆ°á»ng ChÃ¡nh HÆ°ng:");
    (window.locations || [])
      .filter(l => /ÄÃ¬nh|ChÃ¹a|NhÃ  thá»/i.test(l.name) || l.category === "vÄƒn hÃ³a")
      .forEach((loc, i) => {
        const index = i + 1;
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        msg.innerHTML = `ChÃ¡nh HÆ°ng AI: ${index}. <b>${loc.name}</b><br>ğŸ“ ${loc.address}<br>
          <button class="detail-btn" data-name="${loc.name}"
            style="margin-top:4px;background:#b3883b;color:white;border:none;padding:6px 10px;
            border-radius:6px;cursor:pointer;font-size:13px;">ğŸ“– Giá»›i thiá»‡u chi tiáº¿t</button>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    return;
  }

  // --- TOUR TRUNG TÃ‚M THÆ¯Æ NG Máº I ---
  if (/trung tÃ¢m thÆ°Æ¡ng máº¡i|mall|mua sáº¯m|shop|parcmall|central/i.test(t)) {
    appendBot("ğŸ›ï¸ Tour tham quan Trung tÃ¢m thÆ°Æ¡ng máº¡i gá»“m:");
    (window.locations || [])
      .filter(l => /Mall|Trung tÃ¢m|Parc|Central/i.test(l.name) || l.category === "trung tÃ¢m thÆ°Æ¡ng máº¡i")
      .forEach((loc, i) => {
        const index = i + 1;
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        msg.innerHTML = `ChÃ¡nh HÆ°ng AI: ${index}. <b>${loc.name}</b><br>ğŸ“ ${loc.address}<br>
          <button class="detail-btn" data-name="${loc.name}"
            style="margin-top:4px;background:#b3883b;color:white;border:none;padding:6px 10px;
            border-radius:6px;cursor:pointer;font-size:13px;">ğŸ“– Giá»›i thiá»‡u chi tiáº¿t</button>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    return;
  }

  // --- TOUR áº¨M THá»°C ---
  if (/tour áº©m thá»±c|áº©m thá»±c|Äƒn|quÃ¡n|cÃ  phÃª|mÃ¬|nÆ°á»›ng/i.test(t)) {
    appendBot("ğŸœ Äá» xuáº¥t tour áº©m thá»±c táº¡i PhÆ°á»ng ChÃ¡nh HÆ°ng:");
    (window.locations || [])
      .filter(l => /cÃ  phÃª|mÃ¬|nÆ°á»›ng|Highlands|KATINAT|SASIN|LÃ€NG|áº©m thá»±c/i.test(l.name) || l.category === "áº©m thá»±c")
      .forEach((loc, i) => {
        const index = i + 1;
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        msg.innerHTML = `ChÃ¡nh HÆ°ng AI: ${index}. <b>${loc.name}</b><br>ğŸ“ ${loc.address}<br>
          <button class="detail-btn" data-name="${loc.name}"
            style="margin-top:4px;background:#b3883b;color:white;border:none;padding:6px 10px;
            border-radius:6px;cursor:pointer;font-size:13px;">ğŸ“– Giá»›i thiá»‡u chi tiáº¿t</button>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    return;
  }

  // --- TOUR VUI CHÆ I ---
  if (/tour vui chÆ¡i|vui chÆ¡i|thá»ƒ thao|giáº£i trÃ­|hoáº¡t Ä‘á»™ng ngoÃ i trá»i/i.test(t)) {
    appendBot("ğŸ¡ Äá» xuáº¥t tour vui chÆ¡i â€“ thá»ƒ thao táº¡i PhÆ°á»ng ChÃ¡nh HÆ°ng:");
    (window.locations || [])
      .filter(l => /vui chÆ¡i|thá»ƒ thao|Trung tÃ¢m Cung á»¨ng Dá»‹ch Vá»¥/i.test(l.name) || l.category === "vui chÆ¡i")
      .forEach((loc, i) => {
        const index = i + 1;
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        msg.innerHTML = `ChÃ¡nh HÆ°ng AI: ${index}. <b>${loc.name}</b><br>ğŸ“ ${loc.address}<br>
          <button class="detail-btn" data-name="${loc.name}"
            style="margin-top:4px;background:#b3883b;color:white;border:none;padding:6px 10px;
            border-radius:6px;cursor:pointer;font-size:13px;">ğŸ“– Giá»›i thiá»‡u chi tiáº¿t</button>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    return;
  }

  // --- Máº¶C Äá»ŠNH ---
  const found = (window.locations || []).find(l => t.toLowerCase().includes(l.name.toLowerCase()));
  if (found) {
    appendBot(`ğŸ“ ${found.name}\nÄá»‹a chá»‰: ${found.address}`);
    speak(found.address);
  } else {
    appendBot('MÃ¬nh chÆ°a hiá»ƒu, thá»­ nÃ³i "Cho tÃ´i tour áº©m thá»±c" hoáº·c "tour vÄƒn hÃ³a" nhÃ©.');
  }
});
/* greeting */
window.addEventListener('load', async ()=>{
  const greeting = `Xin chÃ o! MÃ¬nh lÃ  ChÃ¡nh HÆ°ng AI â€” hÆ°á»›ng dáº«n viÃªn du lá»‹ch áº£o cá»§a báº¡n táº¡i PhÆ°á»ng ChÃ¡nh HÆ°ng. Báº¡n cÃ³ thá»ƒ cháº¡m vÃ o cÃ¡c ghim Ä‘á»ƒ nghe Ä‘á»‹a chá»‰ hoáº·c chá»n lá»™ trÃ¬nh du lá»‹ch nhÃ© ğŸŒ`;
  appendBot(greeting);
  setTimeout(()=> speak(greeting), 300);
});
/* --- Tab Giá»›i thiá»‡u / Lá»‹ch sá»­ --- */
const openInfoBtn = document.createElement('button');
openInfoBtn.textContent = 'ğŸ“˜ Giá»›i thiá»‡u';
openInfoBtn.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#b3883b;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;z-index:50;cursor:pointer;';
document.body.appendChild(openInfoBtn);

const infoPanel = document.getElementById('infoPanel');
const closeInfoBtn = document.getElementById('closeInfoBtn');
const tabBtns = document.querySelectorAll('.tabBtn');
const tabs = document.querySelectorAll('.tabContent');

openInfoBtn.addEventListener('click', ()=> infoPanel.classList.add('open'));
closeInfoBtn.addEventListener('click', ()=> infoPanel.classList.remove('open'));

tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    tabs.forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    function showDetail(name) {
  const loc = (window.locations || []).find(l => l.name === name);
  if (!loc) return alert("KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin chi tiáº¿t.");
  const text = `ğŸ“ ${loc.name}\n${loc.desc || "ChÆ°a cÃ³ mÃ´ táº£ chi tiáº¿t."}`;
  alert(text);
}
  });
});
</script>
</body>
</html>